{% extends "base.html" %}

{% block title %}Conversation with {{ user.email.split('@')[0] }} - SkillBridge Africa{% endblock %}

{% block extra_head %}
<style>
.profanity-highlight {
    background-color: #fee2e2;
    color: #dc2626;
    text-decoration: underline;
    padding: 0 2px;
    border-radius: 2px;
}
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<section class="bg-gradient-to-r from-primary-600 to-primary-800 text-white py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('messaging.inbox') }}" 
                   class="text-primary-200 hover:text-white transition">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-primary-500 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">{{ user.email.split('@')[0] }}</h1>
                        <p class="text-primary-200 text-sm">{{ user.email }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Messages Container -->
<section class="flex-1 flex flex-col bg-gray-50 min-h-screen">
    <div class="flex-1 max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
        <!-- Messages List -->
        <div id="messages-container" class="bg-white rounded-2xl shadow-lg p-6 mb-6 max-h-96 overflow-y-auto">
            {% if messages %}
                <div class="space-y-4">
                    {% for message in messages %}
                        <div class="flex {% if message.sender_user_id == current_user.id %}justify-end{% else %}justify-start{% endif %}">
                            <div class="max-w-xs lg:max-w-md">
                                <!-- Message Content -->
                                <div class="{% if message.sender_user_id == current_user.id %}bg-primary-600 text-white{% else %}bg-gray-200 text-gray-900{% endif %} rounded-2xl px-4 py-3">
                                    <p class="text-sm">{{ message.content }}</p>
                                </div>
                                
                                <!-- Message Meta -->
                                <div class="flex items-center {% if message.sender_user_id == current_user.id %}justify-end{% else %}justify-start{% endif %} mt-1 space-x-2">
                                    <span class="text-xs text-gray-500">
                                        {% if message.sender_user_id == current_user.id %}You{% else %}{{ user.email.split('@')[0] }}{% endif %}
                                    </span>
                                    <span class="text-xs text-gray-400">
                                        {{ message.created_at.strftime('%I:%M %p') }}
                                    </span>
                                    {% if message.is_admin_message %}
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                                            Admin
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- No Messages -->
                <div class="text-center py-8">
                    <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comment text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Start the conversation</h3>
                    <p class="text-gray-600 text-sm">Send your first message to {{ user.email.split('@')[0] }}</p>
                </div>
            {% endif %}
        </div>
        
        <!-- Send Message Form -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <form method="POST" action="{{ url_for('messaging.send_message') }}" class="space-y-4">
                <input type="hidden" name="recipient_id" value="{{ user.id }}">
                
                <!-- Profanity Warning -->
                <div id="profanity-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3"></i>
                        <div class="text-sm text-red-700">
                            <p class="font-medium mb-1">Inappropriate language detected</p>
                            <p id="profanity-message">Please use polite language in your messages.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Message Input -->
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Your Message</label>
                    <div class="relative">
                        <textarea id="content" name="content" required rows="4" maxlength="1000"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
                                  placeholder="Type your message here..."
                                  oninput="checkProfanity(this.value)"></textarea>
                        <div id="message-preview" class="hidden absolute inset-0 px-4 py-3 bg-white border border-red-300 rounded-lg pointer-events-none"></div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <p class="text-xs text-gray-500">Maximum 1000 characters</p>
                        <span id="char-count" class="text-xs text-gray-500">0 / 1000</span>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Messages are monitored for inappropriate content
                    </div>
                    <button type="submit" id="send-button"
                            class="bg-primary-600 text-white px-6 py-3 rounded-lg hover:bg-primary-700 transition font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Message Guidelines -->
        <div class="mt-6 bg-blue-50 rounded-xl p-4">
            <h3 class="font-semibold text-blue-800 mb-2">
                <i class="fas fa-shield-alt mr-2"></i>Message Guidelines
            </h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>• Be respectful and professional in all communications</li>
                <li>• Avoid sharing personal contact information in messages</li>
                <li>• Report any inappropriate behavior to our admin team</li>
                <li>• Use clear and specific language to avoid misunderstandings</li>
            </ul>
        </div>
    </div>
</section>

<script>
// Character counter
const contentTextarea = document.getElementById('content');
const charCount = document.getElementById('char-count');

contentTextarea.addEventListener('input', function() {
    const count = this.value.length;
    charCount.textContent = `${count} / 1000`;
    
    if (count > 900) {
        charCount.classList.add('text-red-500');
    } else {
        charCount.classList.remove('text-red-500');
    }
});

// Auto-scroll to bottom of messages
const messagesContainer = document.getElementById('messages-container');
if (messagesContainer) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Profanity checking
function checkProfanity(content) {
    if (!content.trim()) {
        hideWarning();
        return;
    }
    
    // This would normally make an AJAX call to check profanity
    // For now, we'll do a simple client-side check
    const profanityWords = ['fuck', 'shit', 'damn', 'bitch', 'bastard', 'ass'];
    const words = content.toLowerCase().split(/\s+/);
    const foundWords = [];
    
    words.forEach(word => {
        // Remove punctuation and check
        const cleanWord = word.replace(/[^\w]/g, '');
        if (profanityWords.some(p => cleanWord.includes(p))) {
            foundWords.push(cleanWord);
        }
    });
    
    if (foundWords.length > 0) {
        showWarning(foundWords);
        highlightProfanity(content, foundWords);
    } else {
        hideWarning();
    }
}

function showWarning(words) {
    const warning = document.getElementById('profanity-warning');
    const message = document.getElementById('profanity-message');
    const sendButton = document.getElementById('send-button');
    
    warning.classList.remove('hidden');
    message.textContent = `Please remove inappropriate language: ${words.join(', ')}`;
    sendButton.disabled = true;
    sendButton.classList.add('opacity-50', 'cursor-not-allowed');
}

function hideWarning() {
    const warning = document.getElementById('profanity-warning');
    const sendButton = document.getElementById('send-button');
    const preview = document.getElementById('message-preview');
    
    warning.classList.add('hidden');
    preview.classList.add('hidden');
    sendButton.disabled = false;
    sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
}

function highlightProfanity(content, words) {
    const preview = document.getElementById('message-preview');
    let highlightedContent = content;
    
    words.forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        highlightedContent = highlightedContent.replace(regex, `<span class="profanity-highlight">${word}</span>`);
    });
    
    preview.innerHTML = highlightedContent;
    preview.classList.remove('hidden');
}

// Auto-refresh messages every 30 seconds
setInterval(function() {
    // In a real application, this would fetch new messages via AJAX
    // For now, we'll just reload the page if there are no messages visible
    if ({{ messages|length }} > 0) {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}
